<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Set your password - Tart</title>
  <link rel="stylesheet" href="/css/style.css" />
</head>
<body class="login-page">
  <div class="login-brand-fixed">Tart</div>
  <div class="login-container">
    <div class="login-card">
      <h1>Set your password</h1>
      <p class="signup-link" style="margin-top:-8px;">You'll use this to sign in next time.</p>

      <div class="password-form">
        <input type="password" id="pw" class="email-input" placeholder="New password" autocomplete="new-password" />
        <input type="password" id="pw2" class="email-input" placeholder="Confirm password" autocomplete="new-password" />
        <button id="save" class="continue-btn">Save password</button>
        <p class="signup-link" style="margin-top: 8px;"><a href="/login.html">Back to login</a></p>
      </div>

      <div id="error" class="error-msg" style="display:none;"></div>
      <div id="ok" class="error-msg" style="display:none; color:#0a7d2b; background:#f0fdf4; border-color:#bbf7d0;">Password saved. Redirecting to loginâ€¦</div>
    </div>

    <div class="login-footer">
      <a href="#">Terms of Use</a>
      <span class="separator">|</span>
      <a href="#">Privacy Policy</a>
    </div>
  </div>

  <script>
    (function(){
      const qs = new URLSearchParams(window.location.search);
      const token = qs.get('token');
      const errorEl = document.getElementById('error');
      const ok = document.getElementById('ok');
      const btn = document.getElementById('save');
      const pw = document.getElementById('pw');
      const pw2 = document.getElementById('pw2');

      function setError(t){
        if (!errorEl) return;
        errorEl.style.display = t ? 'block' : 'none';
        errorEl.textContent = t || '';
        if (ok) ok.style.display = 'none';
      }

      if (!token) {
        setError('Missing verification token. Please restart sign up.');
        btn.disabled = true;
        return;
      }

      btn.addEventListener('click', async function(){
        setError('');
        const p1 = String(pw.value || '');
        const p2 = String(pw2.value || '');
        if (p1.length < 8) { setError('Password must be at least 8 characters.'); return; }
        if (p1 !== p2) { setError('Passwords do not match.'); return; }
        btn.disabled = true;
        try {
          const res = await fetch('/api/auth/set-password', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ token, password: p1 })
          });
          const data = await res.json().catch(() => ({}));
          if (!res.ok) {
            setError((data && data.msg) ? data.msg : 'Failed to set password');
            btn.disabled = false;
            return;
          }
          if (ok) ok.style.display = 'block';
          setTimeout(() => {
            window.location.replace('/login.html?registered=1');
          }, 1000);
        } catch (e) {
          setError('Network error. Please try again.');
          btn.disabled = false;
        }
      });
    })();
  </script>
</body>
</html>
